name: Build H264 Decoder GDExtension

on:
  push:
    paths:
      - 'addons/h264_decoder/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  GODOT_CPP_VERSION: godot-4.2-stable
  FFMPEG_VERSION: 5.1.2

jobs:

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install SCons
        run: pip install scons
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Clone godot-cpp
        run: |
          cd addons/h264_decoder
          git clone --depth 1 --branch ${{ env.GODOT_CPP_VERSION }} https://github.com/godotengine/godot-cpp.git --recursive
      
      - name: Download FFmpeg for Android
        run: |
          cd addons/h264_decoder
          mkdir -p ffmpeg/include ffmpeg/lib
          # Download FFmpeg Android builds from Javernaut/ffmpeg-android-maker
          # Using version 6.0
          
          wget -q https://github.com/Javernaut/ffmpeg-android-maker/releases/download/6.0/ffmpeg-android-6.0.tar.gz
          
          # Extract to temp dir to avoid conflicts
          mkdir -p temp_extract
          tar -xzf ffmpeg-android-6.0.tar.gz -C temp_extract
          
          # Check extraction structure (handle potential root folder)
          if [ -d "temp_extract/ffmpeg-android-6.0" ]; then
            cd temp_extract/ffmpeg-android-6.0
          else
            cd temp_extract
          fi
          
          # Now in the root of extracted files, copy to destination
          # Assumption: structure has 'lib/arm64-v8a' and 'include'
          
          # Move back to project root context for copy
          cd ../../
          
          # Copy libs
          # If output folder exists (Javernaut style sometimes) or just lib
          if [ -d "temp_extract/output/lib" ]; then
             cp -r temp_extract/output/lib/arm64-v8a/* ffmpeg/lib/
             cp -r temp_extract/output/include/* ffmpeg/include/
          elif [ -d "temp_extract/lib/arm64-v8a" ]; then
             cp -r temp_extract/lib/arm64-v8a/* ffmpeg/lib/
             cp -r temp_extract/include/* ffmpeg/include/
          elif [ -d "temp_extract/ffmpeg-android-6.0/lib/arm64-v8a" ]; then
             cp -r temp_extract/ffmpeg-android-6.0/lib/arm64-v8a/* ffmpeg/lib/
             cp -r temp_extract/ffmpeg-android-6.0/include/* ffmpeg/include/
          else
             echo "Unknown structure in tarball"
             ls -R temp_extract
             exit 1
          fi
          
          # Cleanup
          rm -rf temp_extract ffmpeg-android-6.0.tar.gz
      
      - name: Build godot-cpp for Android
        run: |
          cd addons/h264_decoder/godot-cpp
          scons platform=android arch=arm64 target=template_release
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      
      - name: Build extension for Android
        run: |
          cd addons/h264_decoder
          scons platform=android arch=arm64 target=template_release
        env:
          FFMPEG_PATH: ffmpeg
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: h264_decoder-android
          path: addons/h264_decoder/bin/android/
