name: Build H264 Decoder GDExtension

on:
  push:
    paths:
      - 'addons/h264_decoder/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  GODOT_CPP_VERSION: godot-4.2-stable
  FFMPEG_VERSION: 5.1.2

jobs:

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install SCons
        run: pip install scons
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Clone godot-cpp
        run: |
          cd addons/h264_decoder
          git clone --depth 1 --branch ${{ env.GODOT_CPP_VERSION }} https://github.com/godotengine/godot-cpp.git --recursive
      
      - name: Download FFmpeg for Android
        run: |
          cd addons/h264_decoder
          mkdir -p ffmpeg/include ffmpeg/lib
          # Download FFmpeg Android builds from Javernaut/ffmpeg-android-maker
          # Using version 6.0
          
          # 1. Download Libraries & Headers using GitHub CLI (reliable, handles URLs automatically)
          # Repository: Javernaut/ffmpeg-android-maker
          # We prefer 'mobile-ffmpeg-6.0.tar.gz' or similar. We'll download the main archive.
          
          # Auth token is required for gh cli, effectively usually standard GITHUB_TOKEN works or anonymous?
          # Actually, public repos might not need auth for 'gh release download' if using https?
          # Wait, gh cli needs auth. We can use the actions token.
          
          echo "Listing releases to find asset name..."
          gh release download --repo Javernaut/ffmpeg-android-maker --pattern "*.tar.gz" --dir . || gh release download --repo Javernaut/ffmpeg-android-maker --pattern "*.zip" --dir .
          
          # Find what we downloaded
          ARCHIVE_NAME=$(ls *ffmpeg*.tar.gz 2>/dev/null || ls *ffmpeg*.zip 2>/dev/null | head -n 1)
          
          if [ -z "$ARCHIVE_NAME" ]; then
             echo "Failed to download any FFmpeg archive!"
             # Fallback to Khang-NT if Javernaut fails (using gh to be safe)
             echo "Trying Khang-NT fallback..."
             gh release download --repo Khang-NT/ffmpeg-binary-android --pattern "*arm64-v8a.zip" --dir .
             ARCHIVE_NAME=$(ls *arm64-v8a.zip | head -n 1)
          fi
          
          if [ -z "$ARCHIVE_NAME" ]; then
             echo "Still no archive found. Exiting."
             exit 1
          fi
          
          echo "Downloaded: $ARCHIVE_NAME"
          
          # Extract
          mkdir -p temp_extract
          if [[ "$ARCHIVE_NAME" == *.tar.gz ]]; then
             tar -xzf "$ARCHIVE_NAME" -C temp_extract
          elif [[ "$ARCHIVE_NAME" == *.zip ]]; then
             unzip -q "$ARCHIVE_NAME" -d temp_extract
          fi
          
          # Locate files logic (same as before)
          # ... (rest of the logic needs to adapt to finding the folder)
          
          # Find the lib folder recursively
          LIB_DIR=$(find temp_extract -type d -name "lib" | grep "arm64-v8a" | head -n 1 || find temp_extract -type d -name "libs" | grep "arm64-v8a" | head -n 1)
          # If checks failed, try just 'lib' and assume structure
          if [ -z "$LIB_DIR" ]; then 
             LIB_DIR=$(find temp_extract -type d -name "arm64-v8a" | head -n 1)
          fi
          
          echo "Found lib dir: $LIB_DIR"
          
          # Find include dir
          INCLUDE_DIR=$(find temp_extract -type d -name "include" | head -n 1)
          echo "Found include dir: $INCLUDE_DIR"
          
          if [ -n "$LIB_DIR" ] && [ -n "$INCLUDE_DIR" ]; then
             cp -r "$LIB_DIR"/* ffmpeg/lib/
             # If LIB_DIR pointed to arm64-v8a directly, copy contents.
             # If it pointed to 'lib' containing arm64-v8a, we need to go deeper.
             # Our find logic above tries to find the FOLDER that CONTAINS the .so files.
             
             # Let's be safer: copy all .so files from temp_extract to ffmpeg/lib
             find temp_extract -name "*.so" -exec cp {} ffmpeg/lib/ \;
             
             cp -r "$INCLUDE_DIR"/* ffmpeg/include/
          else
             echo "Could not find valid structure in $ARCHIVE_NAME"
             find temp_extract
             exit 1
          fi
          
          # Cleanup
          rm -rf temp_extract "$ARCHIVE_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build godot-cpp for Android
        run: |
          cd addons/h264_decoder/godot-cpp
          scons platform=android arch=arm64 target=template_release
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      
      - name: Build extension for Android
        run: |
          cd addons/h264_decoder
          scons platform=android arch=arm64 target=template_release
        env:
          FFMPEG_PATH: ffmpeg
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: h264_decoder-android
          path: addons/h264_decoder/bin/android/
